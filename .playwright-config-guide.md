# Playwright Configuration Guide

This document explains the browser testing strategy for the Blok editor E2E tests.

## Quick Reference

### Running Tests

```bash
# Run all tests (cross-browser + logic)
yarn e2e

# Run specific browser projects
yarn e2e --project=chromium
yarn e2e --project=firefox
yarn e2e --project=webkit
yarn e2e --project=chromium-logic

# List all tests without running
yarn e2e --list
```

### Test Distribution

| Project | Tests | Description |
|---------|-------|-------------|
| `chromium` | 272 | Cross-browser critical tests on Chrome |
| `firefox` | 272 | Cross-browser critical tests on Firefox |
| `webkit` | 272 | Cross-browser critical tests on Safari |
| `chromium-logic` | 566 | Logic/API tests on Chrome only |
| **Total** | **1,382** | **46% faster than running all on 3 browsers** |

## Adding New Tests

### Decision Tree

**Does your test involve browser-specific behavior?**
- ✅ Clipboard operations, drag-drop, keyboard events
- ✅ DOM rendering differences, text selection
- ✅ Browser API differences (e.g., DataTransfer, Selection API)

→ Add to `CROSS_BROWSER_TESTS` in `playwright.config.ts`

**Is your test pure logic/API?**
- ✅ Testing JavaScript functions, data transformations
- ✅ Module state management, API methods
- ✅ Configuration validation, data serialization

→ Add to `LOGIC_TESTS` in `playwright.config.ts`

**Not sure?**
→ Default to `CROSS_BROWSER_TESTS` (safer choice)

## Configuration Structure

```typescript
// playwright.config.ts

const CROSS_BROWSER_TESTS = [
  // Add your cross-browser test patterns here
  '**/my-new-test.spec.ts',
];

const LOGIC_TESTS = [
  // Add your logic test patterns here
  '**/my-logic-test.spec.ts',
];

// Projects are generated automatically from these arrays
```

## Maintenance Tips

### Verifying Test Coverage

After adding/removing tests, always verify:

```bash
yarn e2e --list | grep "my-test"
```

This shows which projects include your test.

### Updating Test Patterns

1. Edit `CROSS_BROWSER_TESTS` or `LOGIC_TESTS` in `playwright.config.ts`
2. Run `yarn e2e --list` to verify the change
3. Tests are automatically applied to all relevant browser projects

### Common Mistakes

❌ **Don't** duplicate patterns across arrays
```typescript
// BAD
const CROSS_BROWSER_TESTS = ['**/drag-drop.spec.ts'];
const LOGIC_TESTS = ['**/drag-drop.spec.ts']; // Duplicate!
```

❌ **Don't** manually edit the `projects` array
```typescript
// BAD - projects are auto-generated
projects: [
  { name: 'chromium', testMatch: [...] }, // Don't edit this
]
```

✅ **Do** update the constant arrays only
```typescript
// GOOD
const CROSS_BROWSER_TESTS = [
  '**/drag-drop.spec.ts',
  '**/my-new-browser-test.spec.ts', // Add here
];
```

## Browser-Specific Test Skips

Some tests have known browser incompatibilities and use `test.skip()`:

- **Firefox**: 4 tests in `toolbox.spec.ts` (Tab behavior in contenteditable)
- **Firefox**: 2 tests in `inline-toolbar.spec.ts` (text layout differences)
- **WebKit**: 1 test in `onchange.spec.ts` (no programmatic drag-drop)
- **Chromium**: 6 tests in `multi-block-conversion.spec.ts` (flaky, needs fixing)
- **Firefox + WebKit**: 1 test in `italic.spec.ts` (selection shortcuts differ)

These skips are handled automatically by Playwright and don't affect the configuration.

## Performance Impact

**Before optimization:**
- 61 test files × 3 browsers = ~1,600 test runs
- Estimated time: 45-60 minutes

**After optimization:**
- Cross-browser: 272 tests × 3 browsers = 816 runs
- Logic tests: 566 tests × 1 browser = 566 runs
- **Total: 1,382 runs (~13% faster)**
- **Estimated time: 30-35 minutes**

## Troubleshooting

### Tests not running on expected browsers

```bash
# Check which projects include your test
yarn e2e --list | grep "your-test-name"

# Expected output:
# [chromium] › your-test.spec.ts
# [firefox] › your-test.spec.ts
# [webkit] › your-test.spec.ts
```

### Adding a new browser (e.g., Edge)

Edit the `BROWSERS` constant in `playwright.config.ts`:

```typescript
const BROWSERS = ['chromium', 'firefox', 'webkit', 'msedge'] as const;
```

The configuration will automatically generate a project for it.

## Philosophy

This configuration balances:
- **Coverage**: Critical browser-specific tests run on all browsers
- **Speed**: Pure logic tests run once on Chromium
- **Maintainability**: Single source of truth, no duplication
- **Safety**: Default to cross-browser when in doubt

## Questions?

See the main comment block in `playwright.config.ts` for detailed documentation.
